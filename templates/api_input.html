{% extends 'base.html' %}

{% load app_filters %}

{% load static %}

{% block page_title %} Case Record Sheet {% endblock %}

{% block style_code %}
<link href="{% static 'css/bootstrap-table.min.css' %}" rel="stylesheet" />
<style type="text/css">
.fontcss {
  color: #0057e7;
}
</style>
{% endblock %}

{% block javascript_code%}
{% endblock javascript_code%}

{% block primary %}
<h1 class="page-header">Forms <small>Search Passport Id</small></h1>

{% if messages %}
    {% for message in messages %}
    {% if 'error' in message.tags %}
        <div id="messages" class="alert alert-danger fade in">
        <span class="close" data-dismiss="alert">×</span>
        <i class="fa fa-info fa-2x pull-left"></i>
    {% else %}
        <div id="messages" class="alert alert-success fade in">
        <span class="close" data-dismiss="alert">×</span>
        <i class="fa fa-check fa-2x pull-left"></i>
    {% endif %}    
        <p>{{ message }}</p>
    </div>
   {% endfor %}
{% endif %}

<!-- begin caserecord-details-dialog -->
<div class="modal fade" id="caserecord-details-dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h4 class="modal-title">
                <div id="closure-warning-dialog-header">
                    <p>Case History &nbsp;&nbsp;<i class="fa fa-info-circle"></i> </p>      
                </div>
                </h4>
            </div>
            <div class="modal-body">
                <div id="div_casehistory" class="alert alert-white m-b-0">
                    <h6>
                        <p class="fontcss"></p>
                    </h6>                    
                </div>

            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-sm btn-white" data-dismiss="modal">Close</a>
            </div>
        </div>
    </div>
</div>
<!-- end caserecord-details-dialog -->

<div class="row">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-inverse">
                <div class="panel-heading">
                    <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                    </div>                          
                    <h4 class="panel-title"><b>Search Passport</b></h4>
                </div>
                <div class="panel-body">
                    <form id="verification-form" class="form-inline" data-parsley-validate="true">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="search_name">Username:</label>
                            <input type="text" id="search_name" name="search_name" class="form-control" placeholder="Enter search name" required>
                        </div>
                        <div class="form-group">
                            <label for="search_criteria">Password:</label>
                            <input type="password" id="search_criteria" name="search_criteria" class="form-control" placeholder="Enter password" required>
                        </div>
                        <button id="submit-btn" type="submit" class="btn btn-primary">Submit</button>
                        
                        <!-- Hidden button that will be shown after successful verification -->
                        <input id="extra-submit" type="text" class="form-control" value="passportId" style="display:none;">
                        <button id="extra-button" type="button" class="btn btn-success" style="display:none;">Search Passport</button>
                        
                    </form>

                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Handle form submission for verification
        $('#verification-form').on('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission

            var formData = $(this).serialize();  // Serialize form data

            // Send the data to your Django backend via AJAX
            $.ajax({
                type: 'POST',
                url: '{% url "case_record_sheet" %}',  // Your Django view URL
                data: formData,
                success: function(response) {
                    // Check the response content
                    if (!response.includes('Verification Successful')) {
                        // Show the extra input field and button if verification is successful
                        $('#extra-button').show();
                        $('#extra-submit').show();
                    } else {
                        // Handle error cases (e.g., CSRF error, failed verification)
                        alert('Verification failed or server error.');
                    }
                },
                error: function() {
                    alert('An error occurred while processing your request.');
                }
            });
        });

        // Handle the "Search Passport" button click event
        $('#extra-button').on('click', function() {
            var passportId = $('#extra-submit').val();  // Get the value of the extra input field

            // Send the passportId to the separate server via AJAX
            $.ajax({
                type: 'POST',
                url: 'https://separate-server-link.com/search-passport',  // Replace with your server URL
                data: { passportId: passportId },  // Data to be sent to the server
                success: function(response) {
                    alert('Passport search was successful!');  // You can handle the response here
                },
                error: function() {
                    alert('An error occurred while searching for the passport.');
                }
            });
        });
    });
</script>


                         
                </div>
            </div>
        </div>
    </div>

    {% if resultsets %}
    <div class="panel-body">
        <div class="table-responsive">
            <table id="data-table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>First Name</th>
                        <th>Surname</th>
                        <th>Sex</th>  
                        <th>OrgUnit</th>
                        <th>Residence</th>
                        <th>Previous Cases</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in resultsets %}
                    <tr>                                        
                        <td>{{ result.id }}</a></td>
                        <td>{{ result.first_name }}</td>
                        <td>{{ result.surname }}</td>
                        <td>{{ result.sex_id|gen_value:vals }}</td>
                        <td>No OrgUnit Info</td>
                        <td>{{ result.ovc_persongeos }}</td>
                        <td>
                            <h6>
                            <button class="btn  btn-sm btn-link m-r-5" onClick="open_form(2, {{result.id}})" >
                                <b>{{ result.case_count }}</b>                         
                            </button>
                            </h6>
                        </td>
                     
                        <td>                                  
                            <button class="btn  btn-sm btn-primary m-r-5" onClick="open_form(1, {{result.id}})" >
                                <b>New Case Record Sheet</b>&nbsp;&nbsp;<i class="fa fa-file"></i>                          
                            </button>
                        </td>
                    </tr>                              
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
        <div align="center" class="norecords">No records found.</div>
    {% endif %}
</div>

{% endblock %}

{% block lazy_javascript_code %}
<script src="{% static 'plugins/parsley/dist/parsley.js' %}"></script>
<script src="{% static 'js/bootstrap-table.min.js' %}"></script>
<script src="{% static 'js/bootstrap-table-locale-all.min.js' %}"></script>
<script>
function register_new()
{
    return window.location.href='{% url 'new_person' %}'; 
}
function open_form(x, id)
{
    if(x==1)
    {
        // redirect to new_case_record_sheet 
        return window.location.href='{% url 'new_case_record_sheet' id=0 %}'.replace("0", id);
    }
    if(x==2)
    {

        var data = new Array();
        var csrftoken = $.cookie('csrftoken');
        var person_id = id;
        var values = { 
                        'person_id' : person_id,
                        'csrfmiddlewaretoken': csrftoken
                     };
        $.ajax({            
                    url: '{% url 'manage_casehistory' %}',
                    dataType: 'json',
                    method: 'POST',
                    contentType: 'application/x-www-form-urlencoded',
                    data: values,
                    success: function(result)
                    {
                        var msg = ''
                        
                        $.each(result, function(i, val) {
                            var case_serial = val.case_serial;
                            var report_orgunit = val.report_orgunit;
                            var orgunit_contacts = val.orgunit_contacts;
                            var msg_contacts = ''

                            // open case details dialog
                            $('#caserecord-details-dialog').modal('show');

                            if(case_serial)
                            {
                                // get orgunit_contacts
                                $.each(orgunit_contacts, function(i, orgunit_contact)
                                { 
                                    msg_contacts = msg_contacts + '<b><span>' + orgunit_contact.contact_detail_type_id+ ' : </span></b>' + orgunit_contact.contact_detail + '<br>'
                                });

                                msg = msg + '<b>' + '<span class="badge badge-default">' + (i+1) + '</span><br><br><span>Serial Number : </b>' + case_serial + '<br><b>OrgUnit Reported : </b>' + report_orgunit + '</span><br>' + msg_contacts + '<br><br>'

                            }
                            else
                            { 
                                msg = 'No previous case(s).'
                            }
                            
                        });
                        $('#div_casehistory p').html(msg)                      
                    },
                    error: function(xhr, status, error)
                    {
                        alert(error);
                    }
                });               
    }           
}
</script>
<script>
$(document).ready(function() 
{
    $('#data-table').bootstrapTable(
    { 
        toggle: 'table', 
        search: 'true',
        locale: 'en-US',
        pagination: 'true',
        pageNumber: 1,
        pageSize: 10,
        //showRefresh: true,
        showToggle: true,
        //showColumns: true,
        singleSelect: true,
        clickToSelect:true,
        maintainSelected: true        
    });
});
</script>
<!--<script src="{% static 'js/apps.js' %}"></script>-->
{% endblock %}
